"use strict";let userLoggedIn=!1;function openRightPanel(e,o,t=!1,n=!1){var s=.33*screen.width,r=screen.width-s;chrome.windows.create({url:o,type:"panel",focused:n,width:Math.round(s),height:screen.availHeight,top:0,left:Math.round(r)},e=>{t&&chrome.storage.local.set({windowId:e.id})}),chrome.windows.update(e.tab.windowId,{state:"normal",top:0,left:0,width:Math.round(.677*screen.width),height:screen.availHeight})}chrome.storage.local.get(["isLogged"],({isLogged:e})=>{e?chrome.browserAction.setPopup({popup:"./popup/popup-logged.html"}):chrome.browserAction.setPopup({popup:"./popup/popup.html"})}),chrome.runtime.onInstalled.addListener(function(e){"install"==e.reason&&(chrome.tabs.create({url:"https://www.facebook.com/groups/easyquiz"},function(e){alert(`Like fanpage để nhận
thông tin cập nhật, hỗ trợ sử dụng nhé
Click vào icon tiện ích để sử dụng`)}),chrome.tabs.create({url:"https://www.facebook.com/quizpoly"}),chrome.alarms.create("getUser",{when:getDateTomorrow()}),chrome.alarms.get("getUser",e=>{console.debug(e)}),chrome.storage.local.set({quizSelf:{},linkIndex:0}))}),chrome.alarms.get("getUser",e=>{console.debug("alarm bg",e),e||chrome.alarms.create("getUser",{when:getDateTomorrow()})}),chrome.runtime.onMessage.addListener(function(e,o,h){switch(e.type){case"open_quiz_popup":console.debug("open_quiz_popup"),openRightPanel(o,"aqlist.html",!0),h(!0);break;case"open_online_popup":openRightPanel(o,"online.html",!1,!0),h(!0);break;case"focus_quiz_popup":chrome.storage.local.get(["windowId"],({windowId:e})=>{chrome.windows.update(e,{focused:!0})});break;case"close_quiz_popup":chrome.storage.local.get(["windowId"],({windowId:e})=>{chrome.windows.remove(e)});break;case"update_user":updateUser(),h(!0);break;case"send_user_using":sendUserUsing(e);break;case"add_quiz":addQuiz(e.data);break;case"open_quiz_link":openAdsLink(h);break;case"login":t=Math.round(.5*screen.width),n=Math.round(.85*screen.height),s=Math.round(screen.width/2-t/2),r=Math.round(screen.height/2-n/2),chrome.windows.create({url:createAuthEndpoint(),type:"normal",focused:!0,width:t,height:n,left:s,top:r},d=>{var g=window.setInterval(function(){chrome.tabs.query({windowId:d.id},e=>{if(!e.length)return window.clearInterval(g),h("fail");try{const{url:n,title:s}=e[0];if(console.debug(s),n.includes(redirect_uri)&&s.includes("EZQ ")){var o=s.replace("EZQ ","");if(window.clearInterval(g),chrome.windows.remove(d.id),!o)return h("fail"),notify({message:"Đăng nhập không thành công: Can't get userdata"});const{id:r,name:a,email:i,userType:c,premium:u,studentCode:l}=JSON.parse(o);var t={id:r,name:a,email:i,userType:c,premium:u,studentCode:l};chrome.storage.local.set({user:t,isLogged:!0},()=>{var e="Premium"==c&&"Trial3"==u.plan?". Bạn được dùng thử Premium 3 ngày":"";notify({message:"Đăng nhập thành công"+e}),chrome.browserAction.setPopup({popup:"./popup/popup-logged.html"}),h("success")})}}catch(e){return h("fail"),console.log(e),notify({message:`Đăng nhập không thành công: ${e.message}`})}})},500)});break;case"get_quiz_available":getQuizAvailable(e.subject,h);break;case"get_online_answer":getOnlineAnswer(e.subject,h);break;case"add_quiz_self":r=e.data.ans;r&&"object"==typeof r&&(e.data.ans=Object.values(r)),quizSelf[e.seq]=e.data,console.debug(e.data.ans),console.debug(quizSelf);break;case"finish_quiz":console.debug("finish_quiz"),setTimeout(finishQuiz,1e4,e);break;case"get_cookies":chrome.cookies.getAll({domain:e.domain},e=>{console.debug(e);e=e.filter(e=>"sessionid"==e.name||"PHPSESSID"==e.name).map(e=>({name:e.name,value:e.value})),e=e.length?e[0].value:"";h({cookie:e})});break;case"notify_upgraded_premium":notify({message:"Chúc mừng! Tài khoản của bạn đã được nâng cấp lên Premium"});break;case"notify_premium_expired":notify({message:"Hạn dùng Premium của bạn đã hết. Hãy nâng cấp để tiếp tục sử dụng Premium",buttons:[{title:"Nâng cấp"}]},"premium_expired");break;case"logout":chrome.storage.local.set({isLogged:!1,user:{}},()=>{chrome.browserAction.setPopup({popup:"./popup/popup.html"}),h("success")});default:return!0}var t,n,s,r;return!0}),chrome.runtime.onMessageExternal.addListener(function(o,e,n){switch(o.message){case"fetch":fetch(o.url).then(async e=>{var o=await e.text();return{status:e.status,url:e.url,text:o}}).then(e=>n(e)).catch(e=>n(e));break;case"fetch_post":let e=new FormData;for(var[t,s]of o.body)e.append(t,s);fetch(o.url,{method:"post",body:e,headers:o.headers}).then(e=>e.json()).then(e=>n(e)).catch(e=>n(e));break;case"open_quiz_link":openAdsLink(n);break;case"get_quiz_link":chrome.storage.local.get(["linkIndex","getLinkTime"],({linkIndex:e,getLinkTime:o})=>{var t;console.debug("getLinkTime 1",o),o&&"number"==typeof o?(console.debug("getLinkTime 2",o),t=getDiffHours(Date.now(),o),console.log("diffHours",t),24<=t&&(e=0)):e=0,0==e&&(console.debug("set getLinkTime"),o=Date.now(),chrome.storage.local.set({getLinkTime:o})),n(adsLinks[e]),console.debug("linkIndex",e),console.debug("getLinkTime 3",o),(e+=1)==adsLinks.length&&(e=1),chrome.storage.local.set({linkIndex:e})});break;case"get_cms_csrftoken":chrome.cookies.get({url:"https://cms.poly.edu.vn",name:"csrftoken"},e=>{n(e.value)});break;case"send_user_using":sendUserUsing(o);break;case"send_file":console.debug(o);case"get_token":chrome.storage.local.get(["token"],({token:e})=>{n(e||"")});break;case"get_user":console.debug("getUser"),chrome.storage.local.get(["user"],({user:e})=>n(e))}return!0}),chrome.webRequest.onBeforeSendHeaders.addListener(({requestHeaders:e})=>{return e.push({name:"Referer",value:"https://cms.poly.edu.vn"}),{requestHeaders:e}},{urls:["https://cms.poly.edu.vn/*"]},["blocking","requestHeaders","extraHeaders"]),chrome.alarms.onAlarm.addListener(e=>{console.debug(e),"getUser"==e.name&&(updateUser(),chrome.alarms.create("getUser",{when:getDateTomorrow()}))}),chrome.notifications.onButtonClicked.addListener((e,o)=>{"premium_expired"==e&&0==o&&chrome.tabs.create({url:"https://quizpoly.xyz/plans.html"})});