"use strict";var apiUrl="https://api.cap.quizpoly.xyz/quizpoly",version=chrome.runtime.getManifest().version,server=window.location.origin,currentUrl=window.location.href,urlParsed=new URL(currentUrl),quizId=getQuizId(),sequence=getSequence(),canNotGetAvailableAnswerMessage=`Hi·ªán ch∆∞a c√≥ ƒë√°p √°n cho m√¥n h·ªçc n√†y, ph·∫£i t·ª± l√†m r·ªìi üò≠
Sau khi b·∫°n l√†m ƒë√°p √°n s·∫Ω l∆∞u l·∫°i cho ng∆∞·ªùi d√πng sau`;function decodeEntities(e){let t=document.createElement("div");return e&&"string"==typeof e&&(e=(e=e.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,"")).replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),t.innerHTML=e,e=t.textContent,t.textContent=""),e}function parseHTML(e){const t=document.createElement("div");return t.innerHTML=e,t}function getSequence(){return urlParsed.searchParams.get("sequence")||1}async function sendHtml(e,t){try{t=t||document.body.innerHTML.replaceAll("\n","").replaceAll("\t","");const r=await fetch(apiUrl+"/html",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({note:`${version}: ${e}`,html:t})});var n=await r.json();console.debug(n.message)}catch(e){console.debug(e)}}function u(){return new Promise(t=>{chrome.runtime.sendMessage({type:"open_quiz_link"},e=>{console.debug(e),"success"==e||"p"==e?t(!0):("not_logged"==e&&alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ti·ªán √≠ch. Click v√†o icon ti·ªán √≠ch sau ƒë√≥ ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng"),t(!1))})})}function getQuizNumber(){try{let e=document.querySelector(".ilAccAnchor");return e=e||document.querySelector("#kioskTestTitle"),e?Number(e.textContent.replace(/[^0-9]/g,"")):0}catch(e){return 0}}function getSubject(r=document){let t;var n=(e,t)=>{let n=r.querySelector(e);return n?n.textContent.replaceAll("_","-").split(t):[""]};try{let e=r.querySelector("ol > li:nth-child(5) > a");return e?e.textContent.includes("Training sinh vi√™n m·ªõi")?"Training sinh vi√™n m·ªõi":(t=e.textContent.replace("_","-").split("-"),1==t.length&&(t=n("ol > li:nth-child(6) > a","-")),1==t.length&&(t=n("ol > li:nth-child(7) > a","-")),1<t.length?(t=t[1].split(":").pop(),t?t.trim():(sendHtml("subject null"),"")):r.querySelector("ol > li:nth-child(5) > a").textContent.trim()):""}catch(e){return console.debug(e),sendHtml(`getSubject error ${e}`),""}}async function getSubjectById(){try{const e=await fetch(`${server}/ilias.php?baseClass=ilObjTestGUI&cmd=infoScreen&ref_id=${quizId}`);return getSubject(parseHTML(await e.text()))}catch(e){return sendHtml(`getSubjectById error ${e}`),""}}function getQuizId(){return urlParsed.searchParams.get("ref_id")}async function getPassTimes(e){if(window.location.href.includes("outUserPassDetails"))return 0;let n=null;var t="lms-ptcd.poly.edu.vn"==window.location.host?"9r:13t:7j:8c:7q":"q4:ll:vx";try{const r=await fetch(`${server}/ilias.php?ref_id=${e}&cmd=outUserResultsOverview&cmdClass=iltestevaluationgui&cmdNode=${t}&baseClass=ilrepositorygui`);n=await r.text();const o=parseHTML(n),l=o.querySelector(".ilTableFootLight");return l?parseInt(l.textContent.split(" ").pop()):0}catch(t){return chrome.runtime.sendMessage({type:"get_cookies",domain:window.location.host},e=>{sendHtml(`Get PassTimes error: ${t} - ${e.cookie}`,n)}),0}}function writeHTML(e){console.debug(e);let t="",n=1,r=document.createElement("em");var o;for(o of e)r.innerText=o.ans,t+=`
    <tr><td style='width:2.5rem; text-align:center';>${n++}</td><td><svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></td><td>${o.ques}</td></tr>
    <tr><td></td><td><svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></td><td>${r.outerHTML}</td></tr>
    `;chrome.runtime.sendMessage({type:"quiz_data",html:t},function(e){console.debug(e.farewell)})}async function getUserInfo(){let e="NULL",t="NULL",n="NULL",r=server;var o=`${server}/ilias.php?baseClass=ilPersonalDesktopGUI&cmd=jumpToProfile`;let l=null;try{const i=await fetch(o,{method:"GET",redirect:"follow"});if(!i.ok)return{name:e,studentCode:t,term:n,userServer:r};l=await i.text();const s=parseHTML(l);e=s.querySelector("#usr_firstname").value,n=s.querySelector("#usr_lastname").value.replace("(","").replace(")",""),n.includes(" ")&&(e=n,n=""),t=s.querySelector("#hiddenne_un").value,r="lms-ptcd.poly.edu.vn"==window.location.host?"PTCD":r=s.querySelector("#hiddenne_dr").value.replace("USER_","")}catch(t){chrome.runtime.sendMessage({type:"get_cookies",domain:window.location.host},e=>{sendHtml(`getUserInfo error: ${t} - ${e.cookies}`,l)})}return{name:e,studentCode:t,term:n,userServer:r}}async function getQuesId(e,t){t=t||0;let n=null;var r="lms-ptcd.poly.edu.vn"==window.location.host?"9r:13t:7j:8c:7q":"q4:ll:vx",r=`${server}/ilias.php?ref_id=${e}&pass=${t}&cmd=outUserPassDetails&cmdClass=iltestevaluationgui&cmdNode=${r}&baseClass=ilRepositoryGUI`;try{n=await fetch(r,{method:"GET",redirect:"error"});const o=parseHTML(await n.text());return Array.from(o.querySelectorAll("tbody > tr a")).map(e=>e.getAttribute("href"))}catch(e){return console.debug(`getQuesId error: ${e}`),[]}}function getQues(t=document){try{let e=t.querySelector(".ilc_qtitle_Title");if(e)return e.innerText.trim();{let e=document.createElement("div");e.innerHTML=t.querySelector(".ilc_question_Standard").innerHTML.replaceAll("<br>","\n").split("<table")[0];var n=e.querySelector("img");return`${e.innerText.replace(/[^\S\r\n]{2,}/g," ").replaceAll("\n ","\n").trim()}${n?`\n${n.outerHTML}`:""}`}}catch(e){return""}}function getTotalQues(){var e=e=>e.split(" (")[0].split("of ")[1];let t,n;return n=document.querySelector(".small.text-muted"),n&&(t=e(n.textContent)),t||(n=document.querySelector(".ilc_page_title_PageTitle"),n&&(t=e(n.textContent))),t?Number(t):10}async function getQA(e,t){var n="";let r="",o="",l="";const i=await fetch(`${server}/${t}`,{method:"GET",redirect:"error"});var s=await i.text();const a=parseHTML(s);let c=a.querySelector(".ilc_question_Standard:nth-of-type(4) > table > tbody");if(l=c?o="tr > td input:checked":(c=a.querySelector(".ilc_question_Standard:nth-of-type(4) > div > .answer-table"),o="img[title=Checked]"),!c)throw new Error(`tableAnswer null - ${e}`);t=Boolean(c.querySelector("tr > td input[type=checkbox]"));(n=getQues(a))&&"C√¢u h·ªèi"==n||"Question"==n?sendHtml("ques = C√¢u h·ªèi | Question",s):n||sendHtml(`ques null - ${n} ${e}`,s);try{r=t?[...c.querySelectorAll(l)].map(e=>e.parentNode.nextElementSibling.innerText.trim()):(r=c.querySelector(o).parentNode.nextElementSibling.innerText.trim(),r||c.querySelector("tr > td input:checked").parentNode.nextElementSibling.querySelector("img").outerHTML)}catch(e){throw new Error(`getQA error: ${e}`)}if(!r)throw new Error(`ans null - ${e}`);return{ques:n,ans:r}}async function addQuiz(e,t){e?chrome.runtime.sendMessage({type:"add_quiz",data:{subjectName:e,quizzes:t}}):sendHtml("addQuiz: subjectName null")}async function getToken(){return new Promise(t=>{chrome.storage.local.get(["token"],({token:e})=>{chrome.runtime.lastError&&sendHtml(`Can't get token ${chrome.runtime.lastError}`,"NULL"),t(e||"")})})}async function getQuizAvailable(e){return new Promise((n,r)=>{e||(sendHtml(`getQuizAvailable: subjectName null - ${window.location.href}`),alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c t√™n m√¥n h·ªçc"),n([!0,[]])),chrome.runtime.sendMessage({type:"get_quiz_available",subject:e},e=>{return chrome.runtime.lastError?(sendHtml(`Get quiz available error ex - ${window.location.href}: ${chrome.runtime.lastError}`),r()):void(e?([t,e]=e,t?n(e):r()):r());var t})})}function textAnswerNullDebug(){qa&&"direct"==answerType?sendHtml(`Auto answer: Can not get answer ${answerType} 
listQA: ${JSON.stringify(listQA)}`):qa&&(answerType="available")&&sendHtml(`Auto answer: Can not get answer ${answerType} 
subject: ${subjectName}`)}function canNotFindElementAnswerDebug(){sendHtml(`Auto answer: ${subjectName} - ${answerType} - Can not find answer element: ${textAnswer}, answerElement: ${answerElement?.innerText} 
sequence: ${sequence} 
${"direct"==answerType?JSON.stringify(listQA):""}`)}async function sendUserUsing(e,t,n,r){r=r||getQuizNumber(),chrome.runtime.sendMessage({type:"send_user_using",domain:window.location.host,data:{...e,getQuizType:t,subjectName:n,quizNumber:r}})}function autoQuiz(e,t,n,r){r||console.debug("autoQuiz subjectName null");var o=getTotalQues();let l=getQues(),i="",s=Boolean(document.querySelector(".nobackground.ilClearFloat input[type=checkbox]")),a=null,c=!0,u=document.querySelectorAll(".middle>label");u.length||(u=document.querySelectorAll(".middle>span")),u.length||(u=document.querySelectorAll(".ilc_qanswer_Answer label"));const d=[document.querySelector("#nextbutton"),document.querySelector("#bottomnextbutton")];try{if("available"==t||"self_doing"==t){let e=document.querySelectorAll(".nobackground.ilClearFloat tr");if(e.length||(e=document.querySelectorAll(".ilc_qanswer_Answer")),e.forEach(e=>{try{e.addEventListener("click",g)}catch(e){sendHtml(`Auto answer: Add event click to answer error: ${currentUrl}: ${e}`)}}),sequence==o)!function(e,t,n){var r=[...document.querySelectorAll("a[data-nextcmd=outQuestionSummary]"),...document.querySelectorAll("a[data-nextcmd=finishTest]")];if(r.length)for(var o of r)o.addEventListener("click",()=>{c&&e(),chrome.runtime.sendMessage({type:"finish_quiz",domain:window.location.origin,quizId:getQuizId(),passTime:n,subjectName:t}),chrome.storage.local.remove(["listQA"])});else sendHtml(`Auto answer: can not find element to add event click finish quiz: ${window.location.href}`)}(p,r,n);else try{d.forEach(e=>e.addEventListener("click",p))}catch(e){console.debug(e)}}if(!e||!e.length)return;var m;if("direct"==t?i=e[sequence-1].ans:"available"==t&&(m=e.find(e=>e.ques.replaceAll("\r","")===l),console.log(m),m&&(i=m.ans)),console.debug("textAnswer",i),i){if(sequence<o){try{d.forEach(e=>e.style.display="none")}catch(e){sendHtml(`Auto answer: Can not add event click to next button: ${e} - ${window.location.href} - totalQues: ${o}`)}setTimeout(()=>d.forEach(e=>e.style.display=""),1e3)}setTimeout(function(){if(console.log(i),"object"==typeof i)u.forEach(t=>{i.find(e=>e==t.innerText.trim())&&t.dispatchEvent(new MouseEvent("click"))});else{let e=[...u].find(e=>e.querySelector("img")?.outerHTML==i||e.innerText.trim()==i);e?"answertext"==e.getAttribute("class")?e.parentNode.parentNode.querySelector("input").click():e.dispatchEvent(new MouseEvent("click")):console.debug("Can not find element answer")}},700)}else s&&(sequence==o&&(c=!1),setTimeout(()=>{u.forEach(e=>e.dispatchEvent(new MouseEvent("click"))),d.forEach(e=>e.removeEventListener("click",p))},700))}catch(e){sendHtml(`ƒê√£ x·∫£y ra l·ªói khi t·ª± ƒëi·ªÅn ƒë√°p √°n: ${e}`)}function p(){a&&"object"==typeof a&&(a=Object.values(a)),chrome.storage.local.get(["quizSelf"],({quizSelf:e})=>{e[sequence]={ques:l,ans:a},chrome.storage.local.set({quizSelf:e}),console.debug(e[sequence])})}function g(e){let t=e.path[2].querySelector("* > label"),n=t.innerText.trim();n=n||t.innerHTML.replaceAll("\n","").replaceAll("\t","").replace("<span>","").replace("</span>",""),s?(null==a&&(a={}),a[t.getAttribute("for")]=n):a=n,console.debug(a),a||sendHtml("ansChoosed null")}sequence==o&&function(){var e=[...document.querySelectorAll("a[data-nextcmd=outQuestionSummary]"),...document.querySelectorAll("a[data-nextcmd=finishTest]")];if(e.length)for(var t of e)t.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"close_quiz_popup"})})}()}function setAutoQuizData(e,t,n=[]){chrome.storage.local.set({answerType:e,passTime:t,listQA:n},function(){console.debug("set auto quiz data")})}async function resolveQuiz(t=0,n=""){n||((n=(n=getSubject())||await getSubjectById())?chrome.storage.local.set({subjectName:n}):sendHtml("subjectName null after getSubjectById"));const[e,r]=await Promise.all([getPassTimes(quizId),getUserInfo()]).catch(e=>{sendHtml(`get passtime and userinfo error ${e}`)}),o=await getQuesId(quizId,e);let l=[];var i;if(o&&o.length&&(i=o.map(e=>getQA(n,e)),l=await Promise.all(i).catch(e=>{e.message.includes("tableAnswer null")||sendHtml(`getQA promise ${e}`),sendUserUsing(r,"lms-error",`${n} - ${e}`,t)})),l&&l.length){if(!await u())return chrome.runtime.sendMessage({type:"close_quiz_popup"});setAutoQuizData("direct",e,l),writeHTML(l),chrome.runtime.sendMessage({type:"focus_quiz_popup"}),addQuiz(n,l),sendUserUsing(r,"direct",n,t),currentUrl.includes("&sequence=")&&window.location.reload()}else{try{l=await getQuizAvailable(n)}catch{return alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë√°p √°n. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá Admin")}if(l&&l.length){if(!await u())return chrome.runtime.sendMessage({type:"close_quiz_popup"});setAutoQuizData("available",e,l),writeHTML(l),chrome.runtime.sendMessage({type:"focus_quiz_popup"}),sendUserUsing(r,"available",n,t),currentUrl.includes("&sequence=")&&window.location.reload()}else alert(canNotGetAvailableAnswerMessage),setAutoQuizData("self_doing",e),sendUserUsing(r,"self_doing",n,t),chrome.runtime.sendMessage({type:"close_quiz_popup"}),currentUrl.includes("&sequence=")&&window.location.reload()}}async function main({listQA:e,answerType:t,passTime:n,subjectName:r,quizNumber:o,isStart:l,execute:i}){l?(resolveQuiz(o,r).catch(e=>{sendHtml(`Start resolveQuiz error: ${e.message}`),alert(`C√≥ l·ªói x·∫£y ra, l√†m m·ªõi trang xong th·ª≠ l·∫°i ho·∫∑c b√°o l·ªói admin: ${e.message}`)}),chrome.storage.local.set({isStart:!1})):i?(chrome.runtime.sendMessage({type:"open_quiz_popup"}),resolveQuiz(o).catch(e=>sendHtml(`Execute resolveQuiz error: ${e.message}`)),chrome.storage.local.set({execute:!1})):autoQuiz(e,t,n,r)}"function"!=typeof String.prototype.replaceAll&&(String.prototype.replaceAll=function(e,t){return this.split(e).join(t)}),chrome.storage.local.get(["subjectName","answerType","passTime","listQA","quizNumber","isStart","execute"],main);